#include <xc.h>
#include "config_bits.h"
#include "lcd.h"
#include "keypad.h"


#define _XTAL_FREQ 8000000  // Define tu frecuencia aquï¿½

// Mapa del teclado
char teclas[4][4] = {
    {'1', '2', '3', 'A'},
    {'4', '5', '6', 'B'},
    {'7', '8', '9', 'C'},
    {'*', '0', '#', 'D'}
};

Keypad_t miTeclado;
unsigned int piso=0;
unsigned int counter=0;
// Pantalla principal
void idle(void) {
    lcd_clear();
    lcd_printCenter("Bienvenido", 0);
    lcd_setCursor(0, 1);
    lcd_print("Piso: ");
    lcd_printNum(piso);
}

void paro(void){
    while (1){
        lcd_clear();
        lcd_printCenter("PARADA", 0);
        lcd_printCenter("EMERGENCIA", 1);
    }
}


void parada_always(void){
    unsigned int counter=0;
    while (!Keypad_IsPressed(&miTeclado, 'D')){
        delay_ms(10);
        counter++;
        if (counter>=500){
            return;
        }
    }
    paro();
}

void subir(void){
    piso++;
    lcd_clear();
    lcd_printCenter("Subiendo...", 0);
    lcd_setCursor(0, 1);
    lcd_print("Piso: ");
    lcd_printNum(piso);
    parada_always();
    idle();
}

void bajar(void){
    piso--;
    lcd_clear();
    lcd_printCenter("Bajando...", 0);
    lcd_setCursor(0, 1);
    lcd_print("Piso: ");
    lcd_printNum(piso);
    parada_always();
    idle();
}



void main(void) {
    // Configuracion del PIC
    OSCCON = 0x72;  // Configurar oscilador a 8MHz
    ADCON1 = 0x0F;  // Configurar todos los pines como digitales
    CMCON = 0x07;  
    
    // Inicializar LCD
    lcd_begin(16, 2);
    
    // Inicializar teclado
    Keypad_Init(&miTeclado, teclas);
    
    idle();

    while (1) {
        idle();
        // Esperar entrada del usuario
        char tecla = Keypad_WaitForKey(&miTeclado);
        
        switch (tecla) {
            case 'A':
                if (piso<2){
                    subir();
                }else{
                    lcd_clear();
                    lcd_printCenter("Piso mas alto", 0);
                    lcd_printCenter("alcanzado", 1);
                    __delay_ms(2000);
                    idle();
                }
                break;
            case 'B':
                if (piso>0){
                    bajar();
                }else{
                    lcd_clear();
                    lcd_printCenter("Piso mas bajo", 0);
                    lcd_printCenter("alcanzado", 1);
                    __delay_ms(2000);
                    idle();
                }
                break;
            case 'D':
                paro();
                break;
            default:
                // Otra tecla - mostrar mensaje
                lcd_clear();
                lcd_printCenter("Tecla no valida", 0);
                __delay_ms(1000);
                break;
        }
    }
}

//Modify everthing needed to make the emergency stop funtion work properly even when the elevator is moving up or down. The emergency stop function should immediately halt the elevator and display the emergency message on the LCD screen.